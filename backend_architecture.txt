益路同行多端公益教育平台 - 后端架构设计方案 v1.0

1. 技术选型 (Technology Stack)

基于 "Node.js Express + MySQL + Redis" 的核心栈，结合业务需求进行扩展：

1.1 核心框架
- 运行环境: Node.js (LTS 版本, 推荐 v18/v20)
- Web 框架: Express.js
  - 理由: 轻量、灵活、中间件生态丰富，即使是单体架构也能通过路由拆分实现良好的模块化，适合快速迭代 MVP。
- 编程语言: JavaScript (ES6+) 或 TypeScript (强烈推荐)
  - 建议使用 TypeScript 以获得更好的类型提示和代码健壮性，便于多人协作。

1.2 数据存储
- 关系型数据库: MySQL 8.0+
  - 用途: 存储用户信息、视频元数据、直播申请单、审核记录、订单/日志等结构化核心数据。
  - ORM 框架: Prisma 或 Sequelize (推荐 Prisma，类型支持更好，Schema 定义清晰)。
- 缓存/K-V 存储: Redis
  - 用途: 
    - 用户 Session/Token 黑名单 (JWT 管理)
    - 视频/直播的热度计数 (播放量、点赞数的高频写入缓冲)
    - 验证码暂存
    - 简单的消息队列 (如异步转码任务触发，若不引入 RabbitMQ)
    - 直播间实时在线人数统计

1.3 基础设施与第三方服务
- 对象存储 (OSS/COS): 阿里云 OSS / 腾讯云 COS / 七牛云
  - 用途: 存储视频源文件、转码后的切片、封面图、用户头像。
- 内容分发网络 (CDN): 
  - 用途: 加速视频播放和静态资源访问。
- 实时通信 (WebRTC): 腾讯云 TRTC / 声网 Agora / Zego
  - 用途: 提供低延迟直播、连麦互动能力。后端主要负责生成 UserSig/Token 鉴权和房间状体管理。
- AI 服务: 豆包 (Doubao) / 阿里通义 / OpenAI 兼容接口
  - 用途: AI 文本辅导、敏感内容识别 (文本/图片)。
- 部署形式: Docker + PM2
  - 建议容器化部署，便于后续向 K8s 迁移。

2. 系统架构设计 (System Architecture)

采用 "分层模块化架构" (Layered Modular Architecture)。虽然目标包含 "微服务"，但在 Node.js Express 体系下，建议 MVP 阶段采用 "模块化单体 (Modular Monolith)"，各模块内部高内聚、模块间低耦合，未来可根据负载拆分为独立微服务。

分层模型：
[ 客户端层 ] (App / Web / 小程序)
     ⬇
[ 网关/接入层 ] (Nginx / Cloud Gateway) -> SSL 卸载、负载均衡、静态资源
     ⬇
[ 业务应用层 ] (Node.js Express Server)
   ├── 全局中间件 (Error Handle, Logger, Rate Limit, Cors)
   ├── 鉴权中间件 (JWT Auth, RBAC)
   ├── 业务模块 (Routes + Controllers + Services)
   │    ├── Auth Module (认证服务)
   │    ├── User Module (用户中心: 儿童/志愿者/管理员)
   │    ├── Content Module (点播视频: 上传/管理/审核)
   │    ├── Live Module (直播服务: 申请/流状态/WebRTC回调)
   │    ├── Interaction Module (互动: 点赞/收藏/评论)
   │    ├── AI Tutor Module (AI 辅导)
   │    └── System Module (配置/日志/统计)
   └── 数据访问层 (DAL / Repository) -> 封装 DB 操作
     ⬇
[ 数据设施层 ]
   ├── MySQL (主从架构可选)
   ├── Redis (Cluster 可选)
   └── 消息队列 (可选，如 Redis Stream 或 RabbitMQ，用于解耦耗时任务如视频转码完成通知)

3. 数据库核心 Schema 设计 (High-Level)

3.1 用户与权限域
- sys_colleges: 学院表 (id, name, is_active, sort...)
- sys_users: 基础用户表 (id, username, password_hash, role, status, created_at...)
- user_profiles_student: 儿童档案 (user_id, real_name, grade, school, wechat_openid...)
- user_profiles_volunteer: 志愿者档案 (user_id, real_name, student_id, college_id, phone...)
- user_profiles_admin: 管理员档案 (user_id, college_id, type=[PLATFORM|COLLEGE]...)

3.2 内容域
- cms_videos: 视频主表 (id, title, url, cover, uploader_id, college_id, status=[DRAFT|REVIEW|PUBLISHED|REJECTED], audit_remark, duration...)
- cms_video_stats: 视频数据 (video_id, play_count, like_count, fav_count...)
- cms_categories/tags: 分类与标签

3.3 直播域
- live_rooms: 直播间/申请表 (id, title, anchor_id, college_id, plan_start_time, plan_end_time, status=[APPLYING|PASSED|REJECTED|LIVING|FINISHED], push_url, pull_url...)

3.4 互动与审计
- interaction_likes: 点赞记录 (user_id, target_id, target_type)
- interaction_favorites: 收藏记录
- sys_audit_logs: 审计日志 (id, operator_id, action_type, target_id, ip, detail_json, created_at)

4. 关键业务流程技术实现逻辑

4.1 视频上传与审核
1. 客户端请求上传凭证 -> 后端生成 OSS 临时上传签名 (STS) -> 返回客户端。
2. 客户端直传文件到 OSS -> 上传成功后回调/调用后端 "Create Video" 接口提交元数据。
3. 后端写入 `cms_videos`，状态为 `DRAFT` 或 `REVIEW`。
4. 学院管理员调用审核接口 -> 修改状态 -> 若 "通过" 则对学生端可见。

4.2 直播流程
1. 志愿者发起申请 -> 写入 `live_rooms` 表，状态 `APPLYING`。
2. 管理员审核通过 -> 更新状态 `PASSED`，根据 TRTC 规则预生成推流 Key 或 RoomID。
3. 开播时间到 -> 志愿者端获取推流参数 -> 推流到云厂商。
4. 云厂商回调后端 (Webhook) 通知流状态变更 (流开始/流结束) -> 后端更新数据库状态为 `LIVING` 或 `FINISHED`。

4.3 AI 对话
1. 儿童端发送文本 -> 后端 API。
2. 后端先过本地敏感词过滤/云端内容安全检测。
3. 安全通过后，后端作为 Proxy 调用豆包/OpenAI API。
4. 将回复流式 (SSE) 或一次性返回给前端。
5. 记录会话日志用于审计，但不记录敏感隐私。

5. 目录结构建议 (Best Practice)

/etgy_back
  /src
    /config         # 环境变量与配置 (db, redis, oss keys)
    /controllers    # 处理 HTTP 请求参数与响应
    /services       # 核心业务逻辑 (复用性强)
    /models         # 数据库模型定义 (Prisma/Sequelize)
    /middlewares    # 中间件 (Auth, Logger, Validator)
    /routes         # 路由定义 (分模块)
    /utils          # 工具类 (Crypto, Date, UploadHelper)
    /shared         # 常量、类型定义 (Types)
    app.js (or app.ts) # 入口文件
  /logs             # 本地日志
  /scripts          # 运维/初始化脚本
  package.json
  .env

6. 下一步建议
- 确认是否使用 TypeScript (强烈建议)。
- 初始化项目仓库。
- 搭建基础的 Express + Prisma + MySQL 骨架。
- 优先打通 "用户登录 (JWT)" 与 "角色鉴权" 模块。
